import os
import logging
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, ConversationHandler

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω
TOKEN = os.getenv('BOT_TOKEN')
if not TOKEN:
    logger.error("‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞! –î–æ–±–∞–≤—å—Ç–µ BOT_TOKEN")
    exit(1)

# –°–æ—Å—Ç–æ—è–Ω–∏–µ
QUESTION = 1
user_data = {}

# –í–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞
QUESTIONS = [
    "üß≠ –¢–ï–°–¢: –¢–≤—ñ–π —à–ª—è—Ö ‚Äî –≤–ª–∞—Å–Ω–∞ —Å–ø—Ä–∞–≤–∞ —á–∏ —Å—Ç–∞–±—ñ–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞?\n\n"
    "1. –©–æ —Ç–∏ –≤—ñ–¥—á—É–≤–∞—î—à –Ω–∞ —Å–≤–æ—ó–π —Ç–µ–ø–µ—Ä—ñ—à–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ?\n"
    "A. –í—Ç–æ–º–∞, –Ω—É–¥—å–≥–∞, –≤–Ω—É—Ç—Ä—ñ—à–Ω—î –≤–∏–≥–æ—Ä–∞–Ω–Ω—è.\n"
    "B. –ú–µ–Ω—ñ –æ–∫, –∞–ª–µ –ø–æ—Å—Ç—ñ–π–Ω–æ –º—Ä—ñ—é –ø—Ä–æ —â–æ—Å—å –±—ñ–ª—å—à–µ.\n"
    "C. –ü–æ–¥–æ–±–∞—î—Ç—å—Å—è —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å, –∞–ª–µ —â–æ—Å—å —É –º–µ–Ω—ñ —Ö–æ—á–µ –∑–º—ñ–Ω.\n"
    "D. –Ø –ª—é–±–ª—é —Å–≤–æ—é —Ä–æ–±–æ—Ç—É, —ñ –º–µ–Ω—ñ –Ω–µ —Ö–æ—á–µ—Ç—å—Å—è –Ω—ñ—á–æ–≥–æ –º—ñ–Ω—è—Ç–∏.",
    
    "2. –Ø–∫ —Ç–∏ —Å—Ç–∞–≤–∏—à—Å—è –¥–æ –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ—Å—Ç—ñ —Ç–∞ —Ä–∏–∑–∏–∫—ñ–≤?\n"
    "A. –¶–µ –ª—è–∫–∞—î –º–µ–Ω–µ, —è –Ω–µ –≤–∏—Ç—Ä–∏–º—É—é —Å—Ç—Ä–µ—Å—É.\n"
    "B. –Ø –Ω–µ –ª—é–±–ª—é —Ä–∏–∑–∏–∫—É–≤–∞—Ç–∏, –∞–ª–µ –º–æ–∂—É, —è–∫—â–æ –¥—É–∂–µ —Ö–æ—á—É —Å–ø—Ä–∞–≤—É.\n"
    "C. –£ –º—ñ—Ä—É: –≥–æ—Ç–æ–≤–∏–π —Ä–∏–∑–∏–∫—É–≤–∞—Ç–∏, —è–∫—â–æ —î –ø–ª–∞–Ω —ñ —Å–µ–Ω—Å.\n"
    "D. –Ø —Å–ø–æ–∫—ñ–π–Ω–æ –ø–æ—á—É–≤–∞—é—Å—è –≤ —Ö–∞–æ—Å—ñ, –º–µ–Ω—ñ —Ü—ñ–∫–∞–≤–æ –ø—Ä–æ–±—É–≤–∞—Ç–∏.",
    
    "3. –©–æ —Ç–∏ –≤—ñ–¥—á—É–≤–∞—î—à, –∫–æ–ª–∏ –±–∞—á–∏—à –ª—é–¥–∏–Ω—É, —è–∫–∞ —Å—Ç–≤–æ—Ä–∏–ª–∞ —Å–≤–æ—é —Å–ø—Ä–∞–≤—É –∑ –Ω—É–ª—è?\n"
    "A. –î—É–º–∞—é: ¬´–ù—É, —ó–º –ø—Ä–æ—Å—Ç–æ –ø–æ—â–∞—Å—Ç–∏–ª–æ¬ª.\n"
    "B. –ó–∞–∑–¥—Ä—é —Ç—Ä–æ—Ö–∏, –∞–ª–µ –≤—ñ—Ä—é, —â–æ —ñ —è –∑–º—ñ–≥(–∑–º–æ–≥–ª–∞) –±.\n"
    "C. –ú–µ–Ω–µ —Ü–µ –Ω–∞–¥–∏—Ö–∞—î –π –≤–º–∏–∫–∞—î —Ü—ñ–∫–∞–≤—ñ—Å—Ç—å.\n"
    "D. –í –º–µ–Ω—ñ –≤—Å–µ –∑–∞–≥–æ—Ä–∞—î—Ç—å—Å—è ‚Äî —è —Ç–µ–∂ —Ö–æ—á—É!",
    
    "4. –Ø–∫ —Ç–∏ –ø—Ä–∏–π–º–∞—î—à —Ä—ñ—à–µ–Ω–Ω—è?\n"
    "A. –û—á—ñ–∫—É—é —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π –∑–≥–æ—Ä–∏ –∞–±–æ –ø–æ—Ä–∞–¥–∏ –∑–∑–æ–≤–Ω—ñ.\n"
    "B. –ú–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞, –∞–ª–µ —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–∏–π–º–∞—é —Å–∞–º(–∞).\n"
    "C. –ß–∞—Å—Ç–æ –¥—ñ—é —ñ–Ω—Ç—É—ó—Ç–∏–≤–Ω–æ, —ñ —Ü–µ –ø—Ä–∞—Ü—é—î.\n"
    "D. –Ø —à–≤–∏–¥–∫–æ –ø—Ä–∏–π–º–∞—é —Ä—ñ—à–µ–Ω–Ω—è, –≥–æ—Ç–æ–≤–∏–π(–∞) –Ω–µ—Å—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å.",
    
    "5. –£—è–≤–∏, —â–æ —Ç–æ–±—ñ –¥–∞–ª–∏ –ø–æ–≤–Ω—É —Å–≤–æ–±–æ–¥—É: –≥—Ä–æ—à—ñ —î, —á–∞—Å —î. –©–æ —Ç–∏ —Ä–æ–±–∏—à?\n"
    "A. –í—ñ–¥–ø–æ—á–∏–≤–∞—é —Ç–∞ –ø—Ä–æ—Å—Ç–æ –Ω–∞—Å–æ–ª–æ–¥–∂—É—é—Å—å –∂–∏—Ç—Ç—è–º.\n"
    "B. –®—É–∫–∞—é, —á–∏–º –±–∏ –∑–∞–π–Ω—è—Ç–∏—Å—å, –∞–ª–µ –Ω–µ —Ä–≤—É—Å—å –≤ –±—ñ–∑–Ω–µ—Å.\n"
    "C. –ü–æ—á–∏–Ω–∞—é –¥–æ—Å–ª—ñ–¥–∂—É–≤–∞—Ç–∏ —Å–≤–æ—ó —ñ–¥–µ—ó –π –ø—Ä–æ–±—É–≤–∞—Ç–∏ –Ω–æ–≤–µ.\n"
    "D. –í—ñ–¥–∫—Ä–∏–≤–∞—é —Å–≤–æ—é —Å–ø—Ä–∞–≤—É ‚Äî —è –∑–Ω–∞—é, —â–æ —Ö–æ—á—É —Å—Ç–≤–æ—Ä–∏—Ç–∏.",
    
    "6. –Ø–∫ —Ç–∏ —Å—Ç–∞–≤–∏—à—Å—è –¥–æ —Ä—É—Ç–∏–Ω–∏ —Ç–∞ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω–∏—Ö –∑–∞–¥–∞—á?\n"
    "A. –õ—é–±–ª—é —á—ñ—Ç–∫—ñ—Å—Ç—å, –ø—Ä–æ—Ü–µ—Å–∏, –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è ‚Äî —Ü–µ –¥–∞—î —Å–ø–æ–∫—ñ–π.\n"
    "B. –¢–µ—Ä–ø–ª—é, –∞–ª–µ —à–≤–∏–¥–∫–æ –≤–∏–≥–æ—Ä–∞—é.\n"
    "C. –ú–µ–Ω—ñ –≤–∞–∂–∫–æ –±—É—Ç–∏ –≤ —Ä—É—Ç–∏–Ω–∞—Ö ‚Äî –ª—é–±–ª—é —Å–≤–æ–±–æ–¥—É.\n"
    "D. –ú–µ–Ω–µ —Ü–µ –≤–±–∏–≤–∞—î ‚Äî —è —Ö–æ—á—É —Ç–≤–æ—Ä–∏—Ç–∏, –≤–∏—Ä—ñ—à—É–≤–∞—Ç–∏, –≤–ø–ª–∏–≤–∞—Ç–∏.",
    
    "7. –©–æ –¥–ª—è —Ç–µ–±–µ –≤–∞–∂–ª–∏–≤—ñ—à–µ?\n"
    "A. –°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å, –∑–∞—Ä–ø–ª–∞—Ç–∞, —Å–æ—Ü—ñ–∞–ª—å–Ω—ñ –≥–∞—Ä–∞–Ω—Ç—ñ—ó.\n"
    "B. –ë–∞–ª–∞–Ω—Å: —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å + –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—ñ–¥—Ä–æ–±—ñ—Ç–∫—É.\n"
    "C. –í–Ω—É—Ç—Ä—ñ—à–Ω—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ —Å–≤–æ–±–æ–¥–∞ ‚Äî –±—ñ–ª—å—à–µ, –Ω—ñ–∂ –≥–∞—Ä–∞–Ω—Ç—ñ—ó.\n"
    "D. –°–≤–æ–±–æ–¥–∞, —Ä–æ–∑–≤–∏—Ç–æ–∫, –≤–ª–∞—Å–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞. –í—Å–µ —ñ–Ω—à–µ –Ω–µ —Ç–∞–∫ –≤–∞–∂–ª–∏–≤–æ."
]

# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
RESULTS = {
    (7, 11): "üî∏ –¢–æ–±—ñ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –±—ñ–∑–Ω–µ—Å.\n‚ú® –°–ø—Ä–æ–±—É–π –∑–º—ñ–Ω–∏—Ç–∏ –æ—Ç–æ—á–µ–Ω–Ω—è, –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞, –≥—Ä–∞—Ñ—ñ–∫.",
    (12, 17): "üü† –¢–∏ —â–µ —É –ø–æ—à—É–∫—É.\n‚ú® –ó–Ω–∞–π–¥–∏ —Ç–æ—á–∫—É —ñ–Ω—Ç–µ—Ä–µ—Å—É ‚Äî —ñ –ø–æ—á–∏–Ω–∞–π —ñ–∑ –º–∞–ª–æ–≥–æ.",
    (18, 23): "üü° –£ —Ç–µ–±–µ —î –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª –¥–æ –≤–ª–∞—Å–Ω–æ—ó —Å–ø—Ä–∞–≤–∏!\n‚ú® –¢–≤—ñ–π —à–ª—è—Ö ‚Äî —É —Å—Ç–æ—Ä–æ–Ω—É —Å–≤–æ—î—ó —Å–ø—Ä–∞–≤–∏.",
    (24, 28): "üü¢ –ë—ñ–∑–Ω–µ—Å ‚Äî —Ç–≤–æ—î –ø—Ä–∏—Ä–æ–¥–Ω—î —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ!\n‚ú® –ù–µ –≥–∞–ª—å–º—É–π: —É —Ç–æ–±—ñ –≤–∂–µ —î –≤—Å–µ!"
}

def start(update, context):
    user_id = update.effective_user.id
    user_data[user_id] = {'score': 0, 'question': 0}
    
    update.message.reply_text(
        "üîπ –û–±–µ—Ä–∏ –æ–¥–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å, —è–∫–∞ –Ω–∞–π–±—ñ–ª—å—à–µ —Ç–æ–±—ñ –≤—ñ–¥–≥—É–∫—É—î—Ç—å—Å—è.\n"
        "üîπ –í –∫—ñ–Ω—Ü—ñ –±—É–¥–µ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.\n\n"
        "–ü–æ—á–∏–Ω–∞—î–º–æ —Ç–µ—Å—Ç!"
    )
    
    send_question(update, user_id)
    return QUESTION

def send_question(update, user_id):
    data = user_data[user_id]
    question_num = data['question']
    
    if question_num < len(QUESTIONS):
        keyboard = [['A', 'B'], ['C', 'D']]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        update.message.reply_text(QUESTIONS[question_num], reply_markup=reply_markup)
    else:
        show_result(update, user_id)
        return ConversationHandler.END

def handle_answer(update, context):
    user_id = update.effective_user.id
    
    if user_id not in user_data:
        update.message.reply_text("–ù–∞–ø–∏—à–∏ /start —â–æ–± –ø–æ—á–∞—Ç–∏")
        return ConversationHandler.END
    
    answer = update.message.text.upper()
    
    if answer in ['A', 'B', 'C', 'D']:
        scores = {'A': 1, 'B': 2, 'C': 3, 'D': 4}
        user_data[user_id]['score'] += scores[answer]
        user_data[user_id]['question'] += 1
        
        send_question(update, user_id)
        return QUESTION
    else:
        update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–∏—Ä–∞–π A, B, C –∞–±–æ D")
        return QUESTION

def show_result(update, user_id):
    score = user_data[user_id]['score']
    
    result_text = ""
    for (min_s, max_s), text in RESULTS.items():
        if min_s <= score <= max_s:
            result_text = text
            break
    
    update.message.reply_text(
        f"üìä –¢–≤—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score} –±–∞–ª—ñ–≤\n\n{result_text}\n\n/start - –ø—Ä–æ–π—Ç–∏ –∑–Ω–æ–≤—É"
    )
    
    if user_id in user_data:
        del user_data[user_id]

def cancel(update, context):
    user_id = update.effective_user.id
    if user_id in user_data:
        del user_data[user_id]
    
    update.message.reply_text("–¢–µ—Å—Ç —Å–∫–∞—Å–æ–≤–∞–Ω–æ. /start - –ø–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É")
    return ConversationHandler.END

def error(update, context):
    logger.warning('Update "%s" caused error "%s"', update, context.error)

def main():
    # –°–æ–∑–¥–∞–µ–º Updater
    updater = Updater(TOKEN, use_context=True)
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    dp = updater.dispatcher
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏–∞–ª–æ–≥–∞
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            QUESTION: [MessageHandler(Filters.text, handle_answer)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    
    dp.add_handler(conv_handler)
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
    dp.add_error_handler(error)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è...")
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
